\section{Non-vanishing of a Fourier Coefficient}
\label{sec:4}

In this section we will prove Theorem \ref{thm:1.2} that the non-vanishing of the $\psi$-Fourier coefficient of $\sigma$ depends on $\sigma$ only as an abstract representation.
Let $\sigma \subset A_{00}$ and let $\psi$ be a non-trivial character of $k \backslash \bA$.
There exists a $\xi \in k^\times$ such that $\theta(\sigma, \psi^\xi) \neq 0$.
Define $W(\sigma, \psi)$ to be $\theta(\sigma, \psi^\xi) \otimes \chi_\xi$.
By Theorem \ref{thm:2.3}, $W(\sigma, \psi)$ depends only on $\psi$.
Define $L_\psi(\sigma, s)$ to be $L(W(\sigma, \psi), s)$.

\begin{theorem}
\label{thm:4.1}
Let $\sigma = \otimes_v \sigma_v \subseteq A_{00}$.
$\sigma$ admits a non-zero $\psi$-Fourier coefficient if and only if
\begin{enumerate}[label=(\roman*)]
    \item at each place $v$, there is a linear functional $\ell_v$ on the space $W$ of $\sigma_v$ such that
    \[
        \ell_v\left(\sigma\begin{pmatrix}
            1 & t \\ 0 & 1
        \end{pmatrix}w\right) = \psi_v(t) \sigma_v(w) \qquad (w \in W),
    \]
    \item $L(\sigma, \frac{1}{2}) \neq 0$.
\end{enumerate}
\end{theorem}

\begin{proof}
If $\sigma$ admits a non-zero $\psi$-Fourier coefficient, it is clear that (i) is satisfied.
(ii) follows from Theorem \ref{thm:3.3}.
In order to prove the converse state, Waldspurger developed a remarkable method, based on the generalization of the Siegel-Weil formula.
We shall now describe Waldspurger's generalization of the Siegel-Weil formula.
The Siegel-Weil formula for the simplest dual reductive pair $\Sp_{2n}$ and $\rO_{m}$ expresses the integral $\int_{\rO_{m}(k) \backslash \rO_{m}(\bA)} \vartheta_\psi^\phi(g, h) \dd g$
in terms of an Eisenstein series on $\Sp_{2n}$, when $m$ is sufficiently large compared to $n$.
Waldspurger's generalization of the Siegel-Weil formula considers the case when $m$ is small.
Let $T$ be an anisotropic form of $\SO_2$; thus, $T$ is isomorphic to the norm one elements of some quadratic extension $K$ of $k$.
Let $\chi$ be the id\'ele class character associated to $K$. 
Let $X$ be the 2-dimensional space on which $T$ acts, and let $Y$ be 2-dimensional with a symplectic form $\langle \,,\,\rangle$.
Put $Z = X \otimes_k Y$, $\langle x_1 \otimes y_1, x_2 \otimes y_2 \rangle = (x_1, x_2) \langle y_1, y_2 \rangle$.
As usual, $\SO_2 \times \SL_2 \hookrightarrow \Sp_4$.
For $h_v \in \SL_2(k_v)$, we have an Iwasawa decomposition $h_v = \left(\begin{smallmatrix}
    \alpha & * \\ 0 & \alpha^{-1}
\end{smallmatrix}\right) u$ with $u \in \SL_2(\cO_v)$ if $k_v$ is non-archimedean, and $u \in \SO_2(\bR)$ or $u \in \SU_2(\bC)$ in the archimedean case.
Define $A_v(h_v)$ to be $|\alpha|$, and if $h \in \SL_2(\bA)$ put
\[
A(h) = \prod_v A_v(h_v).
\]
We define Eisenstein series by
\[
E^\phi(h, s) = L\left(\chi, s + \frac{1}{2}\right) \sum_{\gamma \in B(k) \backslash \SL_2(k)} A(\gamma h)^{s - \frac{1}{2}}\omega_\psi(\gamma h)\phi(0)
\]
where $\phi$ is a Schwartz-Bruhat function on $X(\bA)$.
Using the standard theory of Eisenstein series, it is easy to show that this Eisenstein series converges absolutely in some half-plane and admits a meromorphic continuation to the entire plane.
We have the following Sieqel-Weil-Waldspurger identity
\[
E^\phi\left(h, \frac{1}{2}\right) = c \int_{T(k) \backslash T(\bA)} \vartheta_\psi^\phi(g, h) \dd g
\]
where $c$ is a constant depending only on $K/k$. This identity can be proved by Poisson summation.
We now return to the proof of Theorem \ref{thm:4.1}.
According to Theorem \ref{thm:3.3}, it is sufficient to prove for the dual reductive pair $\PGL_2, \widetilde{\SL}_2$ such that
\[
\zeta = \int_{\SL_2(k) \backslash \SL_2(\bA)} \varphi(h) \vartheta_\psi^\phi(g, h) \dd h
\]
is non-zero for some choice of $\phi, \varphi$, and $g$.
Suppose $\zeta \equiv 0$.
Since $\varphi \neq 0$, there is $a \in k^\times$ such that $\varphi_{\psi^a} \neq 0$.
If $a \in (k^\times)^2$, then since $\varphi_{\psi}$ and $\varphi_{\psi^{\lambda^2}}$ is related in an elementary fashion, our statement is true.
Thus, we may assume that $k \not\in (k^\times)^2$.
Let $x_a$ be an element of $X$ so that $q(x_a) = a$, and decompose $X$ into the line $(x_a) = kx_a$ generated by $x_a$ and the orthogonal complement $X_a'$.
We may take a $\phi$ of the form $\phi(\lambda x_a + x') = \phi_1(\lambda x_a) \phi_2(x')$ ($x' \in X_a'$).
For $g \in T = \stab (x_a)$, we have
\[
0 \equiv \zeta = \int_{\SL_2(k) \backslash \SL_2(\bA)} \varphi(h) \vartheta_\psi^{\phi_1}(h) \vartheta_{\psi}^{\phi_2}(g, h) \dd h.
\]
Let $K = k(\sqrt{a})$, and let $T$ be the anisotropic torus of the norm-one elements in $K^\times$.
We can integrate with respect to $g\in T(k) \backslash T(\bA)$.
Since $T(k) \backslash T(\bA)$ is compact, we can change the order of integration to obtain
\[
0 \equiv \int_{\SL_2(k) \backslash \SL_2(\bA)} \varphi(h) \vartheta_\psi^{\phi_1}(h) E^{\phi_2}\left(h, \frac{1}{2}\right) \dd h.
\]
Let
\[
\zeta(s) = \int_{\SL_2(k) \backslash \SL_2(\bA)} \varphi(h) \vartheta_\psi^{\phi_1}(h) E^{\phi_2}(h, s) \dd h.
\]
For $\Re(s)$ sufficiently large, the Eisenstein series converges absolutely, and hence we can write
\begin{align*}
    \zeta(s) &= \int_{B(k) \backslash \SL_2(\bA)} \varphi(h) \vartheta_\psi^{\phi_1}(h) L\left(\chi, s + \frac{1}{2}\right) A(h)^{s - \frac{1}{2}} \omega_\phi(h) \phi_2(0) \dd h \\
    &= \int_{N(k) \backslash \SL_2(\bA)} \varphi(h) \omega_\psi'(h) \phi_1(x_a) L\left(\chi, s + \frac{1}{2}\right)A(h)^{s - \frac{1}{2}} \omega_\psi(h) \phi_2(0) \dd h \\
    &= L\left(\chi, s + \frac{1}{2}\right) \int_{N(\bA) \backslash \SL_2(\bA)}\varphi_{\psi^{0}}(h) \omega_\psi'(h)\phi_1(x_a) \omega_\psi(h) \phi_2(0) A(h)^{s- \frac{1}{2}} \dd h \\
    &= L \left(\chi, s + \frac{1}{2}\right) \int_{N(\bA) \backslash \SL_2(\bA)} \varphi_{\psi^{0}}(h) \omega_\psi(h) \phi(x_a) A(h)^{s - \frac{1}{2}} \dd h.
\end{align*}
Each function in the integral factorizes as a product of local factors so
\[
\zeta(s) = L\left(\chi, s + \frac{1}{2}\right) \prod_v \int_{N(k_v) \backslash \SL_2(k_v)} \ell_v(\sigma(h_v) w) \omega_\psi(h_v) \phi_v(x_a) A(h_v)^{s - \frac{1}{2}} \dd h_v
\]
By \S \ref{sec:2}, we know that the local integral $\int_{N(k_v) \backslash \SL_2(k_v)} \ell_v(\sigma(h_v)w) \omega_\psi(h_v)\phi(x_a) A(h_v)^{s -\frac{1}{2}} \dd h_v$ does not vanish identically if and only if $\theta(\sigma_v, \psi_v^{-1}) \neq 0$, which in turn is equivalent to the existence of linear functional $\ell_v$, which transforms under $N(k_v)$ by $\psi_v^a$.
We have
\[
\frac{\zeta(s)}{L_\psi(\sigma, s)} = \prod_v R_v(s),
\]
where $R_v(s) \equiv 1$ for almost all $v$, and $R_v(\frac{1}{2}) \neq 0$ for all $v$.
Since $L_\psi(\sigma, \frac{1}{2}) \neq 0$, we obtain $0 \neq \zeta(\frac{1}{2}) = \zeta$, a contradiction.
Thus $\zeta \neq 0$.
Thus, there exists a $\phi = \prod_v \phi_v$ and a $w = \otimes_v w_v$ such that for all $v$, we have
\[
\int_{N(k_v) \backslash \SL_2(k_v)}  \ell_v(\sigma(h_v) w_v) \omega_{\psi_v}(h_v) \phi_v(x_a) \dd h_v \neq 0.
\]
\end{proof}

\begin{proof}[Proof of Theorem \ref{thm:1.3}]
Let $\sigma_1 = \otimes_v \sigma_{1, v}$, $\sigma_2 = \otimes_v \sigma_{2, v} \subset A_{00}$, and assume that they are nearly equivalent.
In this situation, $\pi_1 = W(\sigma, \psi)$ and $\pi_2 = W(\sigma_2, \psi)$ will have the same local components at almost all places.
By the strong multiplicity theorems for $\PGL_2$, it follows that $\pi_1 \simeq \pi_2$.
This means that $\sigma_{1, v} \simeq \sigma_{2, v}$ at all places $v$ for which $\sigma_{1, v}$ is not a discrete series representation.
Furthermore, at the places $v$ for which $\sigma_{1, v}$ is in the discrete series, it follows from Theorem \ref{thm:2.5} and the local Wa1dspurger involution, that either $\sigma_{2, v} = \sigma_{1, v}$ or $\sigma_{2, v} = \sigma_{1, v}^W$.
Since
\[
\sigma_{1, v}^W \begin{pmatrix}
    -1 & 0 \\ 0 & -1
\end{pmatrix} = -\sigma_{1, v}\begin{pmatrix}
    -1 & 0 \\ 0 & -1
\end{pmatrix},
\]
and $\left(\begin{smallmatrix}
    -1 & 0\\0&-1
\end{smallmatrix}\right) \in \SL_2(k_v)$, the number of places for which $\sigma_{2, v} = \sigma_{1, v}^{W}$ is even.
From this, we conclude that the representations in $A_{00}$ nearly equivalent to $\sigma_1$ must be of the form of $\sigma_1^M$ (see \S 1 for the definition of $\sigma_1^M$).
To complete the proof of Theorem \ref{thm:1.3}, we must show that every $\sigma^M$ (with $|M|$ even) lies in $A_{00}$.
To do this, Waldspurger used a result of Flicker \cite{flicker80covering} which we shall now describe.
Flicker established a correspondence between the representations of $\widetilde{\GL}_2$ and $\GL_2$ $(\rho \mapsto \pi)$.
A representation $\pi = \otimes_v \pi_v$ of $\GL_2$ lies in the image of the Flicker correspondence if and only if at each place $v$ for which $\pi_v$ is a principal series representation $\pi_v = \pi_v(\mu_v^1, \mu_v^2)$ with $\mu_v^1(-1) = \mu_v^2(-1) = 1$.
It is known \cite{waldspurger91quaternion,gps81shimura} that $\pi$ is in the Wa1dspurger correspondence if and only if there is an id\'ele character $\omega$ such that $\pi \otimes \omega$ is in the Flicker correspondence.
Waldspurger used this fact to prove that $\sigma^M$ is automorphic.
\end{proof}